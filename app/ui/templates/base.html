<!DOCTYPE html>
<html lang="{{ locale }}" class="h-full dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>{{ app_name }}{% if page_title %} • {{ page_title }}{% endif %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/assets/css/app.css">
    <style>
        html { min-height: 100%; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            position: relative;
            min-height: 100%;
            background-color: #020617;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }
        /* Fixed gradient canvas so the background never tiles while scrolling */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
            background: linear-gradient(180deg, #020617 0%, #0b1120 50%, #020617 100%);
        }
        body.light-theme {
            color: #0f172a;
            background-color: #f8fafc;
        }
        body.light-theme::before {
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
        }
        body.light-theme .card-surface { background-color: rgba(255, 255, 255, 0.96) !important; color: #0f172a; box-shadow: 0 12px 28px -18px rgba(15, 23, 42, 0.22); border-color: rgba(148, 163, 184, 0.35) !important; }
        body.light-theme .text-slate-100 { color: #0f172a !important; }
        body.light-theme .text-slate-200 { color: #0f172a !important; }
        body.light-theme .text-slate-300 { color: #475569 !important; }
        body.light-theme .text-slate-400 { color: #475569 !important; }
        body.light-theme .text-slate-500 { color: #64748b !important; }

        /* Light theme: convert commonly hard-coded dark surfaces to light surfaces. */
        body.light-theme [class*="bg-slate-950/"] { background-color: rgba(255, 255, 255, 0.92) !important; }
        body.light-theme [class*="bg-slate-900/"] { background-color: rgba(255, 255, 255, 0.86) !important; }
        body.light-theme [class*="border-slate-800/"] { border-color: rgba(148, 163, 184, 0.55) !important; }
        body.light-theme [class*="border-slate-700/"] { border-color: rgba(148, 163, 184, 0.55) !important; }

        /* Navbar + footer need explicit light-mode polish. */
        body.light-theme header.sticky { background: rgba(248, 250, 252, 0.88) !important; border-bottom-color: rgba(148, 163, 184, 0.35) !important; }
        body.light-theme header.sticky a { color: #0f172a !important; }
        body.light-theme header.sticky nav a { color: #475569 !important; }
        body.light-theme header.sticky nav a:hover { color: #0f172a !important; }
        body.light-theme header.sticky nav a.text-white { color: #0f172a !important; }
        body.light-theme header.sticky #theme-toggle,
        body.light-theme header.sticky #mobile-nav-toggle { color: #0f172a !important; border-color: rgba(148, 163, 184, 0.55) !important; }
        body.light-theme header.sticky #theme-toggle:hover,
        body.light-theme header.sticky #mobile-nav-toggle:hover { border-color: rgba(99, 102, 241, 0.45) !important; }
        body.light-theme header.sticky #nav-auth-btn { color: rgb(99, 102, 241) !important; border-color: rgba(99, 102, 241, 0.35) !important; }
        body.light-theme header.sticky #nav-auth-btn:hover { background: rgba(99, 102, 241, 0.08) !important; }

        body.light-theme footer { background: rgba(248, 250, 252, 0.86) !important; border-top-color: rgba(148, 163, 184, 0.35) !important; }
        body.light-theme footer a { color: rgb(99, 102, 241) !important; }
        body.light-theme footer a:hover { color: #0f172a !important; }

        body.light-theme #mobile-nav-panel [data-mobile-nav-drawer] {
            background: rgba(248, 250, 252, 0.96) !important;
            border-left-color: rgba(148, 163, 184, 0.4) !important;
            box-shadow: 0 24px 50px rgba(15, 23, 42, 0.18) !important;
        }
        body.light-theme #mobile-nav-panel nav a.text-white { color: #0f172a !important; }

        /* Keep the app-lock overlay readable even in light mode. */
        body.light-theme #app-lock-overlay { background-color: rgba(2, 6, 23, 0.9) !important; }
        body.light-theme #app-lock-overlay .text-slate-200,
        body.light-theme #app-lock-overlay .text-slate-300,
        body.light-theme #app-lock-overlay .text-white { color: #ffffff !important; }
        body { padding-bottom: env(safe-area-inset-bottom, 0px); }
        main { width: 100%; }
        .input-field {
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid rgba(148,163,184,0.65);
            background: rgba(248,250,252,0.98);
            padding: 0.625rem 1rem;
            font-size: 0.95rem;
            color: #0f172a;
            box-shadow: inset 0 1px 2px rgba(148,163,184,0.35);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
        }
        .input-field::placeholder { color: rgba(71,85,105,0.85); }
        html.dark .input-field {
            background: rgba(15,23,42,0.92);
            border-color: rgba(71,85,105,0.9);
            color: #f1f5f9;
            box-shadow: inset 0 1px 2px rgba(15,23,42,0.55);
        }
        html.dark .input-field::placeholder { color: rgba(148,163,184,0.9); }
        .input-field:focus {
            outline: none;
            border-color: rgb(99,102,241);
            box-shadow: 0 0 0 2px rgba(99,102,241,0.35);
        }
        .toggle-input {
            appearance: none;
            width: 44px;
            height: 22px;
            border-radius: 9999px;
            background: rgba(51,65,85,0.6);
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .toggle-input::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            border-radius: 9999px;
            background: #fff;
            transition: transform 0.2s ease;
        }
        .toggle-input:checked {
            background: rgb(16,185,129);
        }
        .toggle-input:checked::after {
            transform: translateX(22px);
        }
        ::selection { background-color: rgba(129,140,248,0.4); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(148,163,184,0.4); border-radius: 9999px; }
        .spell-editor:empty::before {
            content: attr(data-placeholder);
            color: #64748b;
            pointer-events: none;
        }
        html.dark .spell-editor:empty::before { color: #94a3b8; }
        .spell-error { text-decoration-line: underline; text-decoration-style: wavy; text-decoration-color: #f97316; }
        .spell-tooltip {
            position: fixed;
            z-index: 60;
            min-width: 220px;
            max-width: 280px;
            border-radius: 0.75rem;
            border: 1px solid rgba(148,163,184,0.3);
            background: rgba(15,23,42,0.96);
            color: #e2e8f0;
            box-shadow: 0 20px 40px rgba(15,23,42,0.35);
            padding: 0.5rem;
            display: none;
        }
        .spell-tooltip.light {
            background: rgba(248,250,252,0.98);
            color: #0f172a;
            box-shadow: 0 20px 40px rgba(15,23,42,0.12);
        }
        .spell-tooltip button {
            width: 100%;
            text-align: left;
            border-radius: 0.65rem;
            padding: 0.6rem 0.75rem;
            transition: background-color 0.15s ease, color 0.15s ease;
        }
        .spell-tooltip .suggestion { background: transparent; color: inherit; border: none; }
        .spell-tooltip .suggestion:hover { background: rgba(99,102,241,0.12); color: #c7d2fe; }
        .spell-tooltip .keep { background: transparent; color: inherit; border: 1px solid rgba(148,163,184,0.4); }
        .spell-tooltip .keep:hover { background: rgba(15,23,42,0.4); }
        .spell-tooltip.light .keep:hover { background: rgba(148,163,184,0.12); }
        .hashtag-token { color: #7dd3fc; font-weight: 700; cursor: pointer; }
        .hashtag-token:hover { color: #e0f2fe; }

        /* App lock overlay styling */
        body[data-app-locked="true"] > :not(#app-lock-overlay) {
            filter: blur(6px);
            pointer-events: none;
            user-select: none;
        }
        body[data-app-locked="true"] {
            overflow: hidden;
            overscroll-behavior: none;
        }
        @media (max-width: 640px) {
            body { background-attachment: scroll; }
            main { max-width: 100%; padding: 1.25rem 1rem !important; gap: 1.75rem; }
            header.sticky > div { padding-inline: 0.75rem; }
            .card-surface { padding: 1rem !important; border: 1px solid rgba(100,116,139,0.35); }
            button, .mobile-tap-target { min-height: 44px; }
            .input-field { font-size: 1rem; padding: 0.75rem 0.95rem; }
            #mobile-nav-panel { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem); }
            #story-rail { scroll-snap-type: x mandatory; }
            #story-rail > * { scroll-snap-align: start; }
            #story-modal, #story-viewer { align-items: flex-start; padding: 1.25rem 0.75rem 1.5rem; overflow-y: auto; }
            #story-modal > div, #story-viewer > div { max-width: 100%; border-radius: 22px; }
            #story-preview, #story-viewer-image, #story-viewer-video { max-height: 420px; }
            #ai-chat-container { gap: 0.75rem; }
            #ai-chat-input-row { flex-direction: column; }
            #ai-chat-input { min-height: 48px; }
            #social-ai-overlay[data-social-ai-overlay="true"] { padding: 1rem 0.75rem; align-items: flex-start; }
            #social-ai-overlay [data-social-ai-panel] { height: calc(100vh - 2rem); min-height: 0; max-height: none; grid-template-columns: 1fr; border-radius: 20px; }
            #social-ai-overlay aside { max-height: 32vh; }
            #social-ai-overlay section { max-height: none; }
            #social-ai-form { position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(2,6,23,0.9), rgba(2,6,23,0.98)); border-top: 1px solid rgba(148,163,184,0.2); }
        }
    </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900 transition-colors duration-300 dark:bg-gradient-to-b dark:from-slate-950 dark:via-slate-950 dark:to-slate-900 dark:text-slate-100">
    {{ components.feedback.toast_container() | safe }}
    {{ components.layout.navbar(active=active_nav, t=t) | safe }}
    <main class="mx-auto flex w-full max-w-7xl flex-col gap-10 px-6 py-10 md:px-10">
        {% block content %}{% endblock %}
    </main>
    <footer class="border-t border-slate-800/60 bg-slate-950/70 backdrop-blur">
        <div class="mx-auto flex w-full max-w-7xl flex-col gap-3 px-6 py-6 text-sm text-slate-400 md:flex-row md:items-center md:justify-between md:px-10">
            <p class="text-xs">© {{ app_name }}. {# minimal footer #}</p>
            <div class="flex flex-wrap items-center gap-x-5 gap-y-2 text-xs font-semibold">
                <a href="/terms" target="_blank" rel="noopener" class="text-indigo-300 hover:text-indigo-200">{{ t("footer.terms", "Terms") }}</a>
                <a href="/privacy" class="text-indigo-300 hover:text-indigo-200">{{ t("footer.privacy", "Privacy") }}</a>
                <a href="/community-guidelines" class="text-indigo-300 hover:text-indigo-200">{{ t("footer.guidelines", "Guidelines") }}</a>
            </div>
        </div>
    </footer>
    <div
        id="terms-overlay"
        class="fixed inset-0 z-[60] hidden items-center justify-center bg-slate-950/85 px-4 py-6 backdrop-blur"
        data-terms-overlay="true"
        role="dialog"
        aria-modal="true"
        aria-labelledby="terms-modal-title"
    >
        <div class="w-full max-w-3xl overflow-hidden rounded-[32px] border border-indigo-500/40 bg-slate-950/95 shadow-2xl shadow-indigo-900/40" data-terms-panel>
            <div class="border-b border-white/5 bg-gradient-to-r from-indigo-500/10 via-fuchsia-500/5 to-transparent px-8 py-6">
                <p class="text-[11px] uppercase tracking-[0.4em] text-indigo-200/80">Policy Update</p>
                <div class="mt-2 space-y-2 text-slate-200">
                    <h2 id="terms-modal-title" class="text-2xl font-semibold text-white">Updated Terms &amp; Conditions</h2>
                    <p data-terms-message class="text-sm text-slate-300">{{ terms_block_message }}</p>
                </div>
                <div class="mt-4 flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-[0.3em] text-indigo-200/80">
                    <span data-terms-version class="rounded-full border border-indigo-400/60 px-3 py-1 text-[11px] text-indigo-100">Version {{ terms_version }}</span>
                    <span class="rounded-full border border-slate-700/70 px-3 py-1 text-[11px] text-slate-300">Saskatchewan compliant</span>
                </div>
            </div>
            <div class="max-h-[55vh] overflow-y-auto px-8 py-6 text-left text-sm text-slate-100 whitespace-pre-wrap" data-terms-body>
                Loading the latest contract…
            </div>
            <div class="space-y-4 border-t border-white/5 bg-slate-950/90 px-8 py-6">
                <p class="hidden text-sm font-semibold text-slate-300" data-terms-status></p>
                <label class="grid gap-2 rounded-2xl border border-slate-800/60 bg-slate-950/60 px-4 py-3 text-sm text-slate-200">
                    <span class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">Confirm your birthday (17+)</span>
                    <input
                        id="terms-dob"
                        data-terms-dob
                        type="date"
                        class="input-field"
                        required
                    />
                    <span class="text-xs text-slate-500">We use this to confirm you meet the minimum age requirement.</span>
                </label>
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <button
                        type="button"
                        data-terms-decline
                        class="rounded-2xl border border-slate-700/70 px-5 py-2 text-sm font-semibold text-slate-200 transition hover:bg-slate-800/80"
                    >
                        Decline &amp; sign out
                    </button>
                    <button
                        type="button"
                        data-terms-accept
                        class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-indigo-500 to-violet-500 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-500/30 transition hover:from-indigo-400 hover:to-violet-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-400"
                    >
                        Accept &amp; continue
                    </button>
                </div>
                <p class="text-xs text-slate-400">
                    Need your own copy?
                    <a href="/terms" target="_blank" rel="noopener" class="font-semibold text-indigo-300 hover:text-indigo-200">Download the full document</a>.
                </p>
            </div>
        </div>
    </div>
    <div
        id="social-ai-overlay"
        class="fixed inset-0 z-50 hidden flex items-start justify-center overflow-y-auto bg-slate-950/80 px-4 py-6 sm:items-center sm:py-10 backdrop-blur"
        data-social-ai-overlay="true"
    >
        <div
            data-social-ai-panel
            class="relative grid h-[92vh] min-h-[560px] w-full max-w-5xl grid-cols-1 overflow-hidden rounded-3xl border border-slate-800/70 bg-slate-950 text-white shadow-2xl shadow-black/40 md:grid-cols-[260px,1fr]"
        >
            <aside class="flex h-full flex-col border-b border-slate-900/70 bg-slate-950/80 md:border-b-0 md:border-r">
                <div class="flex items-center justify-between gap-3 border-b border-slate-900/70 px-5 py-4">
                    <div>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-fuchsia-300/70">Sessions</p>
                        <h3 class="text-lg font-semibold">Recent chats</h3>
                    </div>
                    <button
                        id="social-ai-new-chat"
                        type="button"
                        class="rounded-full border border-slate-700/70 px-3 py-1 text-xs font-semibold text-white transition hover:border-fuchsia-500/70 hover:text-fuchsia-200"
                    >
                        + New
                    </button>
                </div>
                <div class="border-b border-slate-900/70 px-5 py-3 text-xs text-slate-400">
                    Create focused threads for different topics. Delete a chat anytime to clear it from history.
                </div>
                <div id="social-ai-session-list" class="scrollbar-thin flex-1 space-y-2 overflow-y-auto px-3 py-4">
                    <p class="rounded-2xl border border-dashed border-slate-800/70 bg-slate-900/50 px-4 py-3 text-xs text-slate-400">
                        No chats yet. Start a new conversation to see it here.
                    </p>
                </div>
            </aside>
            <section class="flex h-full flex-col">
                <header class="flex flex-wrap items-center justify-between gap-4 border-b border-white/5 px-6 py-5">
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-fuchsia-300/70">Social AI</p>
                        <h2 class="text-2xl font-semibold">Your creative co-pilot</h2>
                        <p class="text-sm text-slate-400">Spin up multiple briefs, keep experiments separate, and switch personas on the fly.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative" data-social-ai-mode-menu-root>
                            <button
                                id="social-ai-mode-button"
                                type="button"
                                class="inline-flex flex-col rounded-2xl border border-slate-800/70 bg-slate-900/60 px-3 py-2 text-left text-xs font-semibold text-slate-200 transition hover:border-fuchsia-500/60 hover:text-white"
                            >
                                <span class="text-[10px] uppercase tracking-wide text-slate-500">Mode</span>
                                <span data-social-ai-mode-label>Default</span>
                            </button>
                            <div
                                id="social-ai-mode-menu"
                                class="absolute right-0 top-full z-10 mt-2 hidden w-60 rounded-2xl border border-slate-800/70 bg-slate-950/95 p-2 shadow-2xl shadow-black/50"
                            >
                                <button type="button" data-social-ai-mode-option="default" class="flex w-full flex-col rounded-2xl px-3 py-2 text-left text-sm text-slate-200 transition hover:bg-slate-900/70">
                                    <span class="font-semibold">Default</span>
                                    <span class="text-xs text-slate-500">Friendly guidance + context</span>
                                </button>
                                <button type="button" data-social-ai-mode-option="unhinged" class="mt-1 flex w-full flex-col rounded-2xl px-3 py-2 text-left text-sm text-slate-200 transition hover:bg-slate-900/70">
                                    <span class="font-semibold">Unhinged</span>
                                    <span class="text-xs text-slate-500">Sharp, dark roasts (still safe)</span>
                                </button>
                                <button type="button" data-social-ai-mode-option="deep" class="mt-1 flex w-full flex-col rounded-2xl px-3 py-2 text-left text-sm text-slate-200 transition hover:bg-slate-900/70">
                                    <span class="font-semibold">Deep understanding</span>
                                    <span class="text-xs text-slate-500">Structured, thoughtful analysis</span>
                                </button>
                                <button
                                    type="button"
                                    data-social-ai-mode-option="admin-ops"
                                    data-role-required="admin"
                                    class="mt-1 flex w-full flex-col rounded-2xl border border-amber-500/30 px-3 py-2 text-left text-sm text-amber-100 transition hover:bg-amber-500/10"
                                >
                                    <span class="flex items-center justify-between font-semibold">
                                        <span>Admin / Owner prompt</span>
                                        <span class="rounded-full border border-amber-200/40 px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide text-amber-200">Protected</span>
                                    </span>
                                    <span class="text-xs text-amber-200/80">Toggle high-trust ops mode (admins & owners only)</span>
                                </button>
                            </div>
                        </div>
                        <button
                            type="button"
                            class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-rose-500/60 hover:text-rose-200"
                            data-social-ai-close="true"
                            aria-label="Close Social AI"
                        >
                            ✕
                        </button>
                    </div>
                </header>
                <div class="flex flex-1 flex-col gap-4 px-6 py-5">
                    <div id="social-ai-loading" class="hidden rounded-3xl border border-slate-900/60 bg-slate-950/60 px-4 py-3 text-center text-sm text-slate-300">
                        Preparing Social AI…
                    </div>
                    <div id="social-ai-error" class="hidden rounded-3xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-200"></div>
                    <div class="relative flex-1 min-h-0">
                        <div id="social-ai-thread" class="scrollbar-thin absolute inset-0 space-y-3 overflow-y-auto rounded-3xl border border-slate-900/60 bg-slate-950/60 p-4"></div>
                        <div id="social-ai-empty" class="pointer-events-none absolute inset-0 flex flex-col items-center justify-center rounded-3xl border border-slate-900/60 bg-slate-950/70 p-6 text-center text-sm text-slate-400">
                            <p class="text-base font-semibold text-white">Start a chat with Social AI</p>
                            <p class="mt-1 text-xs text-slate-500">Ask for response drafts, recap a conversation, or plan a group hangout.</p>
                        </div>
                    </div>
                </div>
                <form id="social-ai-form" class="border-t border-slate-900/70 px-6 py-5">
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                        Prompt
                        <textarea
                            id="social-ai-input"
                            rows="3"
                            class="mt-2 w-full rounded-2xl border border-slate-800/70 bg-slate-950/80 p-3 text-sm text-white placeholder:text-slate-500 focus:border-fuchsia-500 focus:outline-none"
                            placeholder="Ask for a reply, recap, or creative idea…"
                            required
                        ></textarea>
                    </label>
                    <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
                        <p class="text-[11px] text-slate-500">Modes adjust tone without compromising community safety.</p>
                        <button
                            id="social-ai-send"
                            type="submit"
                            class="inline-flex items-center gap-2 rounded-full bg-fuchsia-600 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-fuchsia-500/30 transition hover:bg-fuchsia-500 disabled:cursor-not-allowed disabled:opacity-60"
                        >
                            <span>Send</span>
                        </button>
                    </div>
                </form>
            </section>
        </div>
    </div>
    <script>
        window.__LOCALE__ = {{ locale | tojson }};
        window.__I18N__ = {{ i18n_messages | tojson }};
        window.__I18N_DEFAULT__ = {{ i18n_default_messages | tojson }};
    </script>
    <script>
        window.__SOCIAL_CONFIG__ = Object.assign({}, window.__SOCIAL_CONFIG__ || {}, {
            termsVersion: {{ terms_version | tojson }},
            termsMessage: {{ terms_block_message | tojson }},
            termsDocumentUrl: "/terms"
        });
    </script>
    <script src="/assets/js/app.v2.js" defer></script>
    <script>
        (() => {
            function bindMobileNavFallback() {

                setState(false);
                toggle.dataset.bound = 'true';
            }

            function scheduleFallback() {
                window.setTimeout(bindMobileNavFallback, 0);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', scheduleFallback, { once: true });
            } else {
                scheduleFallback();
            }
        })();

        (() => {
            const overlay = document.getElementById('app-lock-overlay');
            const form = document.getElementById('app-lock-form');
            const input = document.getElementById('app-lock-input');
            const errorNode = document.getElementById('app-lock-error');

            if (!overlay || !form || !input) {
                return;
            }

            let locked = false;
            const backgroundNodes = () => Array.from(document.body.children).filter(node => node !== overlay);

            const applyBackgroundInert = (isLocked) => {
                for (const node of backgroundNodes()) {
                    try {
                        if (isLocked) {
                            node.setAttribute('aria-hidden', 'true');
                            node.inert = true;
                        } else {
                            node.removeAttribute('aria-hidden');
                            node.inert = false;
                        }
                    } catch {
                        // inert is not supported everywhere; pointer-events fallback still applies.
                    }
                }
            };

            const stopIfLocked = (event) => {
                if (!locked) return;
                if (overlay.contains(event.target)) return;
                event.preventDefault();
                event.stopImmediatePropagation();
            };

            const trapFocus = (event) => {
                if (!locked) return;
                if (overlay.contains(event.target)) return;
                event.preventDefault();
                window.setTimeout(() => input.focus(), 0);
            };

            const handleKeydownCapture = (event) => {
                if (!locked) return;

                // Keep focus inside the lock dialog.
                if (event.key === 'Tab') {
                    const focusables = overlay.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled'));
                    if (!list.length) {
                        event.preventDefault();
                        input.focus();
                        return;
                    }
                    const current = document.activeElement;
                    const first = list[0];
                    const last = list[list.length - 1];
                    if (event.shiftKey) {
                        if (current === first || !overlay.contains(current)) {
                            event.preventDefault();
                            last.focus();
                        }
                    } else {
                        if (current === last || !overlay.contains(current)) {
                            event.preventDefault();
                            first.focus();
                        }
                    }
                    return;
                }

                // Prevent Enter/Space from triggering background actions.
                if (!overlay.contains(event.target) && (event.key === 'Enter' || event.key === ' ')) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                }
            };

            // Hard block for any click-through edge cases (capture phase).
            document.addEventListener('pointerdown', stopIfLocked, true);
            document.addEventListener('click', stopIfLocked, true);
            document.addEventListener('mousedown', stopIfLocked, true);
            document.addEventListener('touchstart', stopIfLocked, true);
            document.addEventListener('wheel', stopIfLocked, { capture: true, passive: false });
            document.addEventListener('keydown', handleKeydownCapture, true);
            document.addEventListener('focusin', trapFocus, true);

            const unlock = () => {
                locked = false;
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                document.body.dataset.appLocked = 'false';
                applyBackgroundInert(false);
            };

            const showLock = () => {
                locked = true;
                document.body.dataset.appLocked = 'true';
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                applyBackgroundInert(true);
                window.setTimeout(() => input.focus(), 50);
            };

            const setErrorVisible = (visible) => {
                if (!errorNode) return;
                errorNode.classList.toggle('opacity-0', !visible);
            };

            const fetchLockStatus = async () => {
                try {
                    const response = await fetch('/system/app-lock/status', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: { 'Accept': 'application/json' },
                    });
                    if (!response.ok) {
                        return { enabled: true, unlocked: false };
                    }
                    const data = await response.json();
                    return {
                        enabled: Boolean(data && data.enabled),
                        unlocked: Boolean(data && data.unlocked),
                    };
                } catch {
                    return { enabled: true, unlocked: false };
                }
            };

            (async () => {
                const status = await fetchLockStatus();
                // If the feature is disabled on the backend, don't block the UI.
                if (!status.enabled) {
                    unlock();
                    return;
                }
                if (status.unlocked) {
                    unlock();
                    return;
                }
                showLock();
            })();

            form.addEventListener('submit', event => {
                event.preventDefault();
                const provided = (input.value || '').trim();
                if (!provided) {
                    setErrorVisible(true);
                    input.focus();
                    return;
                }

                setErrorVisible(false);

                fetch('/system/app-lock/unlock', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ password: provided }),
                })
                    .then(async (response) => {
                        if (!response.ok) {
                            throw new Error('unlock failed');
                        }
                        return response.json().catch(() => ({}));
                    })
                    .then((data) => {
                        if (data && data.enabled === false) {
                            // Backend has the feature disabled; treat as unlocked.
                            unlock();
                            return;
                        }
                        if (data && data.unlocked) {
                            unlock();
                            return;
                        }
                        throw new Error('unlock failed');
                    })
                    .catch(() => {
                        input.value = '';
                        setErrorVisible(true);
                        input.focus();
                    });
            });
        })();
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
